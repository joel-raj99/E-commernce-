{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///D:/project/E-commernce-/src/app/lib/db.js"],"sourcesContent":["import mongoose from \"mongoose\";\r\n\r\nconst connectDB = async () => {\r\n  if (mongoose.connections[0].readyState) return;\r\n\r\n  try {\r\n    await mongoose.connect(process.env.MONGODB_URI);\r\n    console.log(\"MongoDB connected\");\r\n  } catch (error) {\r\n    console.error(\"MongoDB connection error:\", error);\r\n  }\r\n};\r\n\r\nexport default connectDB;\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,YAAY;IAChB,IAAI,oHAAQ,CAAC,WAAW,CAAC,EAAE,CAAC,UAAU,EAAE;IAExC,IAAI;QACF,MAAM,oHAAQ,CAAC,OAAO,CAAC,QAAQ,GAAG,CAAC,WAAW;QAC9C,QAAQ,GAAG,CAAC;IACd,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;IAC7C;AACF;uCAEe","debugId":null}},
    {"offset": {"line": 186, "column": 0}, "map": {"version":3,"sources":["file:///D:/project/E-commernce-/src/app/models/orderModel.js"],"sourcesContent":["import mongoose from \"mongoose\";\r\n\r\nconst orderSchema = new mongoose.Schema(\r\n  {\r\n    userId: { type: mongoose.Schema.Types.ObjectId, ref: \"User\", required: true },\r\n    items: [\r\n      {\r\n        productId: {\r\n          type: mongoose.Schema.Types.ObjectId,\r\n          ref: \"Product\",\r\n          required: true,\r\n        },\r\n        quantity: { type: Number, required: true },\r\n        price: { type: Number, required: true },\r\n      },\r\n    ],\r\n    totalAmount: { type: Number, required: true },\r\n    address: { type: String, required: true },\r\n    paymentMethod: { type: String, required: true },\r\n    status: { type: String, default: \"Pending\" },\r\n  },\r\n  { timestamps: true }\r\n);\r\n\r\nconst Order = mongoose.models.Order || mongoose.model(\"Order\", orderSchema);\r\nexport default Order;\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,cAAc,IAAI,oHAAQ,CAAC,MAAM,CACrC;IACE,QAAQ;QAAE,MAAM,oHAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,KAAK;QAAQ,UAAU;IAAK;IAC5E,OAAO;QACL;YACE,WAAW;gBACT,MAAM,oHAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,QAAQ;gBACpC,KAAK;gBACL,UAAU;YACZ;YACA,UAAU;gBAAE,MAAM;gBAAQ,UAAU;YAAK;YACzC,OAAO;gBAAE,MAAM;gBAAQ,UAAU;YAAK;QACxC;KACD;IACD,aAAa;QAAE,MAAM;QAAQ,UAAU;IAAK;IAC5C,SAAS;QAAE,MAAM;QAAQ,UAAU;IAAK;IACxC,eAAe;QAAE,MAAM;QAAQ,UAAU;IAAK;IAC9C,QAAQ;QAAE,MAAM;QAAQ,SAAS;IAAU;AAC7C,GACA;IAAE,YAAY;AAAK;AAGrB,MAAM,QAAQ,oHAAQ,CAAC,MAAM,CAAC,KAAK,IAAI,oHAAQ,CAAC,KAAK,CAAC,SAAS;uCAChD","debugId":null}},
    {"offset": {"line": 240, "column": 0}, "map": {"version":3,"sources":["file:///D:/project/E-commernce-/src/app/models/cartModel.js"],"sourcesContent":["import mongoose from \"mongoose\";\r\n\r\nconst cartSchema = new mongoose.Schema({\r\n  userId: { type: mongoose.Schema.Types.ObjectId, ref: \"User\", required: true },\r\n  items: [\r\n    {\r\n      productId: {\r\n        type: mongoose.Schema.Types.ObjectId,\r\n        ref: \"Product\",\r\n        required: true,\r\n      },\r\n      quantity: { type: Number, required: true, min: 1 },\r\n    },\r\n  ],\r\n});\r\n\r\nconst Cart = mongoose.models.Cart || mongoose.model(\"Cart\", cartSchema);\r\nexport default Cart;\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,aAAa,IAAI,oHAAQ,CAAC,MAAM,CAAC;IACrC,QAAQ;QAAE,MAAM,oHAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,QAAQ;QAAE,KAAK;QAAQ,UAAU;IAAK;IAC5E,OAAO;QACL;YACE,WAAW;gBACT,MAAM,oHAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,QAAQ;gBACpC,KAAK;gBACL,UAAU;YACZ;YACA,UAAU;gBAAE,MAAM;gBAAQ,UAAU;gBAAM,KAAK;YAAE;QACnD;KACD;AACH;AAEA,MAAM,OAAO,oHAAQ,CAAC,MAAM,CAAC,IAAI,IAAI,oHAAQ,CAAC,KAAK,CAAC,QAAQ;uCAC7C","debugId":null}},
    {"offset": {"line": 273, "column": 0}, "map": {"version":3,"sources":["file:///D:/project/E-commernce-/src/app/api/order/route.js"],"sourcesContent":["// import { NextResponse } from \"next/server\";\r\n// import Stripe from \"stripe\";\r\n// import connectDB from \"../../lib/db.js\";\r\n// import Order from \"../../models/orderModel.js\";\r\n// import Cart from \"../../models/cartModel.js\";\r\n\r\n\r\n// const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);\r\n\r\n// export async function POST(req) {\r\n//   try {\r\n//     await connectDB();\r\n\r\n//     const { userId, address, paymentMethod } = await req.json();\r\n\r\n//     // ‚úÖ Fetch cart\r\n//     const cart = await Cart.findOne({ userId }).populate(\"items.productId\");\r\n//     if (!cart || cart.items.length === 0) {\r\n//       return NextResponse.json({ message: \"Cart is empty\" }, { status: 400 });\r\n//     }\r\n\r\n//     // ‚úÖ Calculate total\r\n//     const totalAmount = cart.items.reduce(\r\n//       (acc, item) => acc + item.productId.price * item.quantity,\r\n//       0\r\n//     );\r\n\r\n//     if (paymentMethod === \"COD\") {\r\n//       // üßæ Directly create COD order\r\n//       const newOrder = new Order({\r\n//         userId,\r\n//         items: cart.items.map((item) => ({\r\n//           productId: item.productId._id,\r\n//           quantity: item.quantity,\r\n//           price: item.productId.price,\r\n//         })),\r\n//         totalAmount,\r\n//         address,\r\n//         paymentMethod: \"COD\",\r\n//         status: \"Pending\",\r\n//       });\r\n\r\n//       await newOrder.save();\r\n\r\n//       // üßπ Clear cart\r\n//       cart.items = [];\r\n//       await cart.save();\r\n\r\n//       return NextResponse.json(\r\n//         { message: \"Order placed successfully (COD)\", order: newOrder },\r\n//         { status: 201 }\r\n//       );\r\n//     } else if (paymentMethod === \"Online\") {\r\n//       // üí≥ Create Stripe Checkout Session\r\n//       const session = await stripe.checkout.sessions.create({\r\n//         payment_method_types: [\"card\"],\r\n//         mode: \"payment\",\r\n//         line_items: cart.items.map((item) => ({\r\n//           price_data: {\r\n//             currency: \"inr\",\r\n//             product_data: {\r\n//               name: item.productId.name,\r\n//             },\r\n//             unit_amount: item.productId.price * 100, // Stripe expects paise\r\n//           },\r\n//           quantity: item.quantity,\r\n//         })),\r\n//         success_url: `${process.env.NEXT_PUBLIC_BASE_URL}/payment/success?session_id={CHECKOUT_SESSION_ID}`,\r\n//         cancel_url: `${process.env.NEXT_PUBLIC_BASE_URL}/payment/cancel`,\r\n//         metadata: {\r\n//           userId,\r\n//           address,\r\n//           totalAmount,\r\n//         },\r\n//       });\r\n\r\n//       return NextResponse.json({ url: session.url }, { status: 200 });\r\n//     } else {\r\n//       return NextResponse.json(\r\n//         { message: \"Invalid payment method\" },\r\n//         { status: 400 }\r\n//       );\r\n//     }\r\n//   } catch (error) {\r\n//     console.error(\"Order POST error:\", error);\r\n//     return NextResponse.json(\r\n//       { message: \"Error processing order\", error: error.message },\r\n//       { status: 500 }\r\n//     );\r\n//   }\r\n// }\r\n\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport Stripe from \"stripe\";\r\nimport twilio from \"twilio\";\r\nimport connectDB from \"../../lib/db.js\";\r\nimport Order from \"../../models/orderModel.js\";\r\nimport Cart from \"../../models/cartModel.js\";\r\n\r\n// üîë Initialize Stripe\r\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY);\r\n\r\n// üîë Initialize Twilio\r\nconst twilioClient = twilio(\r\n  process.env.TWILIO_ACCOUNT_SID,\r\n  process.env.TWILIO_AUTH_TOKEN\r\n);\r\n\r\nexport async function POST(req) {\r\n  try {\r\n    await connectDB();\r\n\r\n    const { userId, address, paymentMethod, phone } = await req.json();\r\n\r\n    // ‚úÖ Fetch cart\r\n    const cart = await Cart.findOne({ userId }).populate(\"items.productId\");\r\n    if (!cart || cart.items.length === 0) {\r\n      return NextResponse.json({ message: \"Cart is empty\" }, { status: 400 });\r\n    }\r\n\r\n    // ‚úÖ Calculate total\r\n    const totalAmount = cart.items.reduce(\r\n      (acc, item) => acc + item.productId.price * item.quantity,\r\n      0\r\n    );\r\n\r\n    // ===============================\r\n    // üßæ CASE 1: Cash On Delivery (COD)\r\n    // ===============================\r\n    if (paymentMethod === \"COD\") {\r\n      const newOrder = new Order({\r\n        userId,\r\n        items: cart.items.map((item) => ({\r\n          productId: item.productId._id,\r\n          quantity: item.quantity,\r\n          price: item.productId.price,\r\n        })),\r\n        totalAmount,\r\n        address,\r\n        paymentMethod: \"COD\",\r\n        status: \"Pending\",\r\n      });\r\n\r\n      await newOrder.save();\r\n\r\n      // üßπ Clear cart after order placed\r\n      cart.items = [];\r\n      await cart.save();\r\n\r\n      // üì© Send SMS via Twilio\r\n      try {\r\n        await twilioClient.messages.create({\r\n          body: `Hi! Your COD order #${newOrder._id} has been placed successfully. Total: ‚Çπ${totalAmount}. Thank you for shopping with us!`,\r\n          from: process.env.TWILIO_PHONE_NUMBER, // Twilio phone number\r\n          to: phone, // user's phone number with +91 prefix\r\n        });\r\n      } catch (smsError) {\r\n        console.error(\"‚ùå SMS sending failed:\", smsError.message);\r\n      }\r\n\r\n      return NextResponse.json(\r\n        { message: \"Order placed successfully (COD)\", order: newOrder },\r\n        { status: 201 }\r\n      );\r\n    }\r\n\r\n    // ===============================\r\n    // üí≥ CASE 2: Online Payment (Stripe)\r\n    // ===============================\r\n    else if (paymentMethod === \"Online\") {\r\n      const session = await stripe.checkout.sessions.create({\r\n        payment_method_types: [\"card\"],\r\n        mode: \"payment\",\r\n        line_items: cart.items.map((item) => ({\r\n          price_data: {\r\n            currency: \"inr\",\r\n            product_data: {\r\n              name: item.productId.name,\r\n            },\r\n            unit_amount: item.productId.price * 100, // Stripe expects in paise\r\n          },\r\n          quantity: item.quantity,\r\n        })),\r\n        success_url: `${process.env.NEXT_PUBLIC_BASE_URL}/payment/success?session_id={CHECKOUT_SESSION_ID}`,\r\n        cancel_url: `${process.env.NEXT_PUBLIC_BASE_URL}/payment/cancel`,\r\n        metadata: {\r\n          userId,\r\n          address: JSON.stringify(address),\r\n          totalAmount,\r\n          phone, // include phone in metadata for SMS after success\r\n        },\r\n      });\r\n\r\n      return NextResponse.json({ url: session.url }, { status: 200 });\r\n    }\r\n\r\n    // ===============================\r\n    // ‚ùå Invalid Payment Method\r\n    // ===============================\r\n    else {\r\n      return NextResponse.json(\r\n        { message: \"Invalid payment method\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Order POST error:\", error);\r\n    return NextResponse.json(\r\n      { message: \"Error processing order\", error: error.message },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}